{% extends "base.html" %}

{% block title %}AI Chatbot - Maternal Food Recommendation AI{% endblock %}

{% block extra_css %}
<style>
    #chat-container {
        height: 500px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
        background-color: #f8f9fa;
    }
    
    .message {
        margin-bottom: 1rem;
        padding: 0.75rem;
        border-radius: 0.375rem;
        max-width: 80%;
    }
    
    .user-message {
        background-color: #007bff;
        color: white;
        margin-left: auto;
        text-align: right;
    }
    
    .bot-message {
        background-color: #ffffff;
        border: 1px solid #dee2e6;
    }
    
    .suggestion-btn {
        margin: 0.25rem;
        white-space: normal;
        text-align: left;
    }
    
    .loading-dots::after {
        content: '.';
        animation: dots 1.5s steps(4, end) infinite;
    }
    
    @keyframes dots {
        0%, 20% { content: '.'; }
        40% { content: '..'; }
        60%, 100% { content: '...'; }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">
                <i class="fas fa-robot text-primary"></i> AI Food Chatbot
            </h1>
            <p class="lead text-muted">
                Ask me anything about pregnancy nutrition! Currently in Trimester {{ current_user.current_trimester }}
            </p>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Chat Container -->
            <div id="chat-container" class="mb-3">
                <div class="bot-message message">
                    <strong><i class="fas fa-robot"></i> Chatbot:</strong>
                    <p class="mb-0">
                        Hello {{ current_user.full_name }}! I'm here to help you with pregnancy nutrition questions. 
                        Ask me about food safety, benefits, preparation methods, or nutrition information.
                    </p>
                </div>
            </div>

            <!-- Input Area -->
            <div class="card">
                <div class="card-body">
                    <div class="input-group">
                        <input 
                            type="text" 
                            id="question-input" 
                            class="form-control" 
                            placeholder="Type your question here..."
                            onkeypress="handleKeyPress(event)"
                        >
                        <button class="btn btn-primary" onclick="sendQuestion()">
                            <i class="fas fa-paper-plane"></i> Send
                        </button>
                    </div>
                    <small class="text-muted">
                        <i class="fas fa-lightbulb"></i> Example: "Can I eat papaya during pregnancy?"
                    </small>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Suggested Questions -->
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <i class="fas fa-question-circle"></i> Suggested Questions
                </div>
                <div class="card-body" id="suggestions-container">
                    <div class="text-center">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <span class="ms-2">Loading suggestions...</span>
                    </div>
                </div>
            </div>

            <!-- Recent Queries (Optional) -->
            <div class="card mt-3">
                <div class="card-header bg-secondary text-white">
                    <i class="fas fa-history"></i> Recent Questions
                </div>
                <div class="card-body" id="history-container" style="max-height: 300px; overflow-y: auto;">
                    <p class="text-muted small">Your recent questions will appear here</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Load suggestions on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadSuggestions();
        loadHistory();
    });

    function loadSuggestions() {
        fetch('/chatbot/api/suggestions')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('suggestions-container');
                if (data.success && data.suggestions) {
                    container.innerHTML = '';
                    data.suggestions.forEach(suggestion => {
                        const btn = document.createElement('button');
                        btn.className = 'btn btn-outline-primary btn-sm suggestion-btn w-100';
                        btn.textContent = suggestion;
                        btn.onclick = () => askSuggestion(suggestion);
                        container.appendChild(btn);
                    });
                } else {
                    container.innerHTML = '<p class="text-muted small">No suggestions available</p>';
                }
            })
            .catch(error => {
                console.error('Error loading suggestions:', error);
                document.getElementById('suggestions-container').innerHTML = 
                    '<p class="text-muted small">Could not load suggestions</p>';
            });
    }

    function loadHistory() {
        fetch('/chatbot/api/history?limit=5')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('history-container');
                if (data.success && data.history && data.history.length > 0) {
                    container.innerHTML = '';
                    data.history.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'border-bottom pb-2 mb-2';
                        div.innerHTML = `
                            <p class="small mb-0">${item.question}</p>
                            <small class="text-muted">${new Date(item.timestamp).toLocaleDateString()}</small>
                        `;
                        container.appendChild(div);
                    });
                }
            })
            .catch(error => {
                console.error('Error loading history:', error);
            });
    }

    function askSuggestion(question) {
        document.getElementById('question-input').value = question;
        sendQuestion();
    }

    function handleKeyPress(event) {
        if (event.key === 'Enter') {
            sendQuestion();
        }
    }

    function sendQuestion() {
        const input = document.getElementById('question-input');
        const question = input.value.trim();
        
        if (!question) {
            alert('Please enter a question');
            return;
        }

        // Add user message to chat
        addMessage('user', question);
        
        // Clear input
        input.value = '';

        // Show loading message
        const loadingId = addMessage('bot', '<span class="loading-dots">Thinking</span>');

        // Send to API
        fetch('/chatbot/api/ask', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ question: question })
        })
        .then(response => response.json())
        .then(data => {
            // Remove loading message
            removeMessage(loadingId);
            
            if (data.success) {
                // Format answer with markdown-like rendering
                const formattedAnswer = formatAnswer(data.answer);
                addMessage('bot', formattedAnswer);
                
                // Reload history
                loadHistory();
            } else {
                addMessage('bot', `<span class="text-danger">Error: ${data.error || 'Could not get answer'}</span>`);
            }
        })
        .catch(error => {
            removeMessage(loadingId);
            console.error('Error:', error);
            addMessage('bot', '<span class="text-danger">Sorry, an error occurred. Please try again.</span>');
        });
    }

    function formatAnswer(text) {
        // Simple markdown-like formatting
        text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Bold
        text = text.replace(/\n/g, '<br>'); // Line breaks
        return text;
    }

    function addMessage(type, content) {
        const container = document.getElementById('chat-container');
        const messageDiv = document.createElement('div');
        const messageId = 'msg-' + Date.now();
        messageDiv.id = messageId;
        messageDiv.className = `message ${type}-message`;
        
        if (type === 'user') {
            messageDiv.innerHTML = `<strong>You:</strong><p class="mb-0">${content}</p>`;
        } else {
            messageDiv.innerHTML = `<strong><i class="fas fa-robot"></i> Chatbot:</strong><p class="mb-0">${content}</p>`;
        }
        
        container.appendChild(messageDiv);
        container.scrollTop = container.scrollHeight;
        
        return messageId;
    }

    function removeMessage(messageId) {
        const msg = document.getElementById(messageId);
        if (msg) {
            msg.remove();
        }
    }
</script>
{% endblock %}
